{% extends "base.html" %}

{% block title %}Prediction - Movie Review Detector{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- User Welcome Section -->
    <div class="welcome-section mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 mb-2">Welcome, {{ current_user.username }}!</h1>
                <p class="lead text-muted">Analyze movie reviews to detect potential fake content.</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="user-stats-badge">
                    <span class="badge bg-primary">
                        <i class="fas fa-chart-line me-1"></i>Accuracy: {{ user_stats.accuracy|default(0) }}%
                    </span>
                    <span class="badge bg-success ms-2">
                        <i class="fas fa-search me-1"></i>{{ user_stats.reviews_analyzed|default(0) }} Reviews
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Review Input Section -->
            <div class="review-input-card mb-4">
                <h3 class="mb-3">Enter Review for Analysis</h3>
                <div class="mb-3">
                    <label for="movieTitle" class="form-label">Movie Title</label>
                    <input type="text" class="form-control" id="movieTitle" 
                           placeholder="Enter the movie title...">
                </div>
                <div class="mb-3">
                    <label for="reviewText" class="form-label">Review Text</label>
                    <textarea id="reviewText" class="form-control" rows="6" 
                              placeholder="Paste the movie review here..."></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="saveAnalysis">
                        <label class="form-check-label" for="saveAnalysis">
                            Save to my history
                        </label>
                    </div>
                    <button id="analyzeBtn" class="btn btn-primary btn-lg">
                        <i class="fas fa-search me-2"></i>Analyze Review
                    </button>
                </div>
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useClientSideAnalysis" checked>
                        <label class="form-check-label" for="useClientSideAnalysis">
                            Use client-side analysis (works offline)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div id="resultCard" class="result-card mb-4 d-none">
                <div class="card-body">
                    <h3 class="card-title mb-4">Analysis Results</h3>
                    <div class="result-content">
                        <!-- Verdict Section -->
                        <div class="verdict-section mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Verdict</h4>
                                <span id="verdictBadge" class="badge"></span>
                            </div>
                            <div class="progress mt-3">
                                <div id="confidenceBar" class="progress-bar" role="progressbar"></div>
                            </div>
                            <p id="confidenceText" class="text-muted mt-2 text-end"></p>
                        </div>

                        <!-- Features Grid -->
                        <div class="features-grid">
                            <div class="row g-3">
                                <!-- Sentiment Analysis -->
                                <div class="col-md-6">
                                    <div class="feature-box">
                                        <h5><i class="fas fa-heart me-2"></i>Sentiment Analysis</h5>
                                        <ul id="sentimentList" class="list-unstyled">
                                        </ul>
                                    </div>
                                </div>
                                <!-- Text Analysis -->
                                <div class="col-md-6">
                                    <div class="feature-box">
                                        <h5><i class="fas fa-font me-2"></i>Text Analysis</h5>
                                        <ul id="textList" class="list-unstyled">
                                        </ul>
                                    </div>
                                </div>
                                <!-- Model Performance -->
                                <div class="col-12">
                                    <div class="feature-box">
                                        <h5><i class="fas fa-chart-bar me-2"></i>Model Performance</h5>
                                        <div class="row g-3" id="modelMetrics">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="stats-card mb-4">
                <h3 class="mb-3">Your Analysis Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ user_stats.reviews_analyzed|default(0) }}</h4>
                            <p>Reviews Analyzed</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ user_stats.fake_detected|default(0) }}</h4>
                            <p>Fake Reviews Found</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ user_stats.accuracy|default(0) }}%</h4>
                            <p>Your Accuracy</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Analyses -->
            <div class="recent-analyses-card">
                <h3 class="mb-3">Recent Analyses</h3>
                <div id="recentAnalyses" class="recent-list">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .welcome-section {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-top: -1rem;
    }

    .user-stats-badge .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }

    .review-input-card, .result-card, .stats-card, .recent-analyses-card {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #reviewText {
        resize: none;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        font-size: 16px;
    }

    #analyzeBtn {
        background-color: var(--primary-color);
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    #analyzeBtn:hover {
        background-color: var(--dark-color);
        transform: translateY(-2px);
    }

    .verdict-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .progress {
        height: 10px;
        border-radius: 5px;
        background-color: #e9ecef;
    }

    .progress-bar {
        transition: width 0.6s ease;
    }

    .feature-box {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        height: 100%;
    }

    .feature-box h5 {
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    .feature-box ul li {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .genuine {
        color: #27ae60;
    }

    .fake {
        color: #e74c3c;
    }

    .result-content {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }

    .result-content.show {
        opacity: 1;
        transform: translateY(0);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        transition: transform 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    .stat-info h4 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--dark-color);
    }

    .stat-info p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .recent-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .recent-item {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.3s ease;
    }

    .recent-item:hover {
        background-color: #f8f9fa;
    }

    .recent-item:last-child {
        border-bottom: none;
    }

    .metric-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
    }

    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const movieTitle = document.getElementById('movieTitle');
    const reviewText = document.getElementById('reviewText');
    const saveAnalysis = document.getElementById('saveAnalysis');
    const useClientSideAnalysis = document.getElementById('useClientSideAnalysis');
    const resultCard = document.getElementById('resultCard');
    const verdictBadge = document.getElementById('verdictBadge');
    const confidenceBar = document.getElementById('confidenceBar');
    const confidenceText = document.getElementById('confidenceText');
    const sentimentList = document.getElementById('sentimentList');
    const textList = document.getElementById('textList');
    const modelMetrics = document.getElementById('modelMetrics');
    const recentAnalyses = document.getElementById('recentAnalyses');

    analyzeBtn.addEventListener('click', async function() {
        const reviewText = document.getElementById('reviewText').value.trim();
        const movieTitle = document.getElementById('movieTitle').value.trim();
        const saveAnalysis = document.getElementById('saveAnalysis').checked;
        const useClientSide = document.getElementById('useClientSideAnalysis').checked;
        
        if (!reviewText) {
            alert('Please enter a review to analyze');
            return;
        }
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
        
        try {
            let data;
            
            if (useClientSide) {
                // Use client-side analysis
                console.log('Using client-side analysis');
                data = generateMockPrediction(reviewText);
            } else {
                // Try server-side analysis
                try {
                    const response = await fetch('/analyze_review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            review: reviewText,
                            movie_title: movieTitle,
                            save: saveAnalysis
                        })
                    });
                    
                    // Check if response is OK
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    
                    // Try to parse the response as JSON
                    const text = await response.text();
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.error('Failed to parse JSON:', text);
                        throw new Error('Server returned invalid data');
                    }
                    
                    // Check for error in the response data
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Check if prediction data is valid
                    if (!data.prediction || !data.features) {
                        throw new Error('Invalid prediction data received from server');
                    }
                } catch (serverError) {
                    console.error('Server-side analysis failed:', serverError);
                    
                    // Fallback to client-side analysis
                    console.log('Falling back to client-side analysis');
                    data = generateMockPrediction(reviewText);
                    
                    // Show a warning that we're using client-side analysis
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'alert alert-warning mt-3';
                    warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Using client-side analysis due to server error. Results are not accurate.';
                    resultCard.appendChild(warningDiv);
                }
            }
            
            // Update UI with results
            displayResults(data);
            
            // Add to history if analysis was saved
            if (saveAnalysis) {
                addToHistory(movieTitle, reviewText, data);
            }
            
        } catch (error) {
            console.error('Error:', error);
            // Use client-side analysis as a fallback
            const data = generateMockPrediction(reviewText);
            displayResults(data);
            
            // Show warning about using client-side analysis
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning mt-3';
            warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Using client-side analysis due to error. Results are not accurate.';
            resultCard.appendChild(warningDiv);
        } finally {
            // Reset button state
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-search me-2"></i>Analyze Review';
        }
    });
    
    function displayResults(data) {
        // Show result card
        resultCard.classList.remove('d-none');
        
        // Set verdict
        const isFake = data.prediction === 'fake';
        verdictBadge.textContent = isFake ? 'Fake Review' : 'Genuine Review';
        verdictBadge.className = `badge ${isFake ? 'bg-danger' : 'bg-success'}`;
        
        // Set confidence
        const confidence = data.confidence * 100;
        confidenceBar.style.width = `${confidence}%`;
        confidenceBar.className = `progress-bar ${isFake ? 'bg-danger' : 'bg-success'}`;
        confidenceBar.setAttribute('aria-valuenow', confidence);
        confidenceText.textContent = `${confidence.toFixed(1)}% confidence`;
        
        // Clear and populate sentiment features
        sentimentList.innerHTML = '';
        const sentimentFeatures = [
            { label: 'Category', value: data.features.sentiment_category },
            { label: 'Polarity', value: data.features.sentiment_polarity },
            { label: 'Subjectivity', value: data.features.sentiment_subjectivity },
            { label: 'Objectivity', value: data.features.sentiment_objectivity }
        ];
        
        sentimentFeatures.forEach(feature => {
            const item = document.createElement('li');
            item.innerHTML = `<strong>${feature.label}:</strong> ${feature.value}`;
            sentimentList.appendChild(item);
        });
        
        // Clear and populate text features
        textList.innerHTML = '';
        Object.entries(data.features).forEach(([key, value]) => {
            if (!key.startsWith('sentiment_')) {
                const item = document.createElement('li');
                item.innerHTML = `<strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}`;
                textList.appendChild(item);
            }
        });
        
        // Clear and populate model metrics
        modelMetrics.innerHTML = '';
        const metrics = data.model_metrics;
        const metricItems = [
            { label: 'Accuracy', value: metrics.accuracy },
            { label: 'Precision', value: metrics.precision },
            { label: 'Recall', value: metrics.recall },
            { label: 'F1 Score', value: metrics.f1_score }
        ];
        
        metricItems.forEach(metric => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-3';
            col.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${(parseFloat(metric.value) * 1).toFixed(1)}%</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `;
            modelMetrics.appendChild(col);
        });
        
        // Animate result content
        setTimeout(() => {
            document.querySelector('.result-content').classList.add('show');
        }, 100);
    }
    
    function addToHistory(title, review, data) {
        const historyItem = document.createElement('div');
        historyItem.className = 'recent-item';
        
        const isFake = data.prediction === 'fake';
        const confidence = (data.confidence * 100).toFixed(1);
        const date = new Date().toLocaleDateString();
        
        historyItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h5 class="mb-1">${title || 'Untitled Review'}</h5>
                    <small class="text-muted">${date}</small>
                </div>
                <span class="badge ${isFake ? 'bg-danger' : 'bg-success'}">${isFake ? 'Fake' : 'Genuine'}</span>
            </div>
            <p class="mb-2">${review.substring(0, 100)}${review.length > 100 ? '...' : ''}</p>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Confidence: ${confidence}%</small>
                <button class="btn btn-sm btn-outline-primary" onclick="reanalyzeReview('${review}')">
                    <i class="fas fa-redo me-1"></i>Reanalyze
                </button>
            </div>
        `;
        
        // Add to top of recent analyses
        recentAnalyses.insertBefore(historyItem, recentAnalyses.firstChild);
        
        // Limit recent items
        if (recentAnalyses.children.length > 5) {
            recentAnalyses.removeChild(recentAnalyses.lastChild);
        }
    }
    
    // Function to reanalyze a review (can be called from recent analyses)
    window.reanalyzeReview = function(review) {
        reviewText.value = review;
        analyzeBtn.click();
    };

    // Function to generate mock prediction data
    function generateMockPrediction(text) {
        // Simple heuristics for fake detection
        const uppercaseRatio = (text.match(/[A-Z]/g) || []).length / text.length;
        const exclamationRatio = (text.match(/!/g) || []).length / text.length;
        const wordCount = text.split(/\s+/).length;
        
        // Determine if review is likely fake based on heuristics
        const isFake = uppercaseRatio > 0.3 || exclamationRatio > 0.05 || wordCount < 20;
        const confidence = Math.min(0.7 + (uppercaseRatio * 0.3), 0.95);
        
        // Generate sentiment data
        const sentiment = {
            category: uppercaseRatio > 0.3 ? 'negative' : (wordCount > 100 ? 'positive' : 'neutral'),
            polarity: uppercaseRatio > 0.3 ? -0.7 : (wordCount > 100 ? 0.7 : 0),
            subjectivity: Math.min(0.3 + (exclamationRatio * 5), 0.9),
            variance: 0.2
        };
        
        // Generate text features
        const features = {
            word_count: wordCount,
            avg_word_length: text.replace(/\s+/g, '').length / wordCount,
            capitalization_ratio: uppercaseRatio,
            punctuation_ratio: (text.match(/[.,!?]/g) || []).length / text.length,
            unique_words_ratio: new Set(text.toLowerCase().split(/\s+/)).size / wordCount,
            sentiment_category: sentiment.category,
            sentiment_polarity: sentiment.polarity.toFixed(2),
            sentiment_subjectivity: sentiment.subjectivity.toFixed(2),
            sentiment_objectivity: (1 - sentiment.subjectivity).toFixed(2)
        };
        
        return {
            prediction: isFake ? 'fake' : 'genuine',
            confidence: confidence,
            features: features,
            sentiment: sentiment,
            model_metrics: {
                accuracy: '85.0%',
                precision: '83.0%',
                recall: '82.0%',
                f1_score: '82.0%'
            }
        };
    }
});
</script>
{% endblock %} 